<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>GeoCulture</title>

  <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="css/base.css"/>

    <link rel="stylesheet" href="css/leaflet.css"/>
    <script src="js/leaflet.js"></script>

    <!--<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>-->

    <!--<link rel="stylesheet" href="css/coord-projection.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.min.js"></script>
    <script src="js/coord-projection.js"></script>-->

    <link rel="stylesheet" href="css/easy-button.css"/>
    <script src="js/easy-button.js"></script>

    <link rel="stylesheet" href="css/locate.min.css"/>
    <script src="js/locate.min.js"></script>

    <link rel="stylesheet" href="css/fullscreen.css"/>
    <script src="js/fullscreen.js"></script>

    <link rel="stylesheet" href="css/sidepanel.css"/>
    <script src="js/sidepanel.js"></script>

    <link rel="stylesheet" href="css/markercluster.css"/>
    <link rel="stylesheet" href="css/markercluster.default.css"/>
    <script src="js/markercluster.js"></script>

    <link rel="stylesheet" href="css/spotlight.min.css">
    <script src="js/spotlight.min.js"></script>

    <script src="poi.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    .leaflet-container {
      height: 100%;
      width: 100%;
      max-width: 100%;
      max-height: 100%;
    }
  </style>


</head>
<body>

  <div id="map" style="width: 100%; height: 100%;">
    <div id="attributes" class="sidepanel" aria-label="side panel" aria-hidden="false">
      <div class="sidepanel-inner-wrapper">
        <nav class="sidepanel-tabs-wrapper" aria-label="sidepanel tab navigation">
          <ul class="sidepanel-tabs">
            <li class="sidepanel-tab">
              <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-1"> Artwork </a>
            </li>
            <li class="sidepanel-tab">
              <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-2"> Author </a>
            </li>
          </ul>
        </nav>
        <div class="sidepanel-content-wrapper">
          <div class="sidepanel-content">
            <div class="sidepanel-tab-content" data-tab-content="tab-1"> </div>
            <div class="sidepanel-tab-content" data-tab-content="tab-2"> </div>
          </div>
        </div>
      </div>
      <div class="sidepanel-toggle-container">
        <button class="sidepanel-toggle-button" type="button" aria-label="toggle side panel"></button>
      </div>
    </div>
  </div>

<script>
  var   debug  = true;
  const panelw = 400;
  const map = L.map('map', {zoomControl: false, zoomSnap: 0.5});


  const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    opacity: 0.7,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);

  // add coordinates control
  // coordP = L.control.coordProjection().addTo(map);

  // add scale control
  var scaleControl = new L.Control.Scale({
            maxwidth: 300,
            position: 'bottomleft',
            metric: true,
            imperial: false,
            updateWhenIdle: true
        });
  scaleControl.addTo(map);

  // add zoom bar
  var zoomBar = L.easyBar([
    L.easyButton('<b>+</b>', function(control, map){map.setZoom(map.getZoom()+1)}),
    L.easyButton('<img src="css/house.svg" width="90%" height="90%">',
      function(control, map){map.fitBounds(allbounds)}),
    L.easyButton('<b>-</b>', function(control, map){map.setZoom(map.getZoom()-1)})
  ]);
  zoomBar.addTo(map);

  // add filter buttons
  var filterbar = L.easyBar([
    L.easyButton ('<img src="css/filter.svg" width="90%" height="90%">',
      function (control, map) {if (lastpr) {findbyfnln(curfn,curln);populatepanel(lastpr)}}),
    L.easyButton ('<img src="css/filter-circle-xmark.svg" width="90%" height="90%">',
      function (control, map) {findbyfnln();curfn='';info.update()})
  ]);
  filterbar.addTo(map);

  // add locate
  L.control.locate().addTo(map);

  // add fullscreen
  map.addControl(
    new L.Control.FullScreen({
      position: 'topleft',
      title: 'Fullscreen',
      titleCancel: 'Exit Fullscreen'
    })
  );

  // side panel
  var attrpanel = L.control.sidepanel('attributes', {
    panelPosition: 'right',
    hasTabs: true,
    tabsPosition: 'top',
    pushControls: true,
    darkMode: true,
    startTab: 'tab-1'
  })
  attrpanel.addTo(map);

  map.on ('click', function(e) {
     attrpanel.doClose (map);
  });


  // landscape paintings layer
  function populatepanel (pr) {

    let t1 = document.querySelectorAll("div.sidepanel-tab-content")[0];
    t1.textContent="";

    let t1h1 = document.createElement('h1');
    t1h1.innerText = pr.name;
    t1h1.setAttribute ('style',"display: block; margin: 0; margin-bottom: 8px; line-height:1.2");
    t1.appendChild(t1h1);

    let t1c = document.createElement('small');
    t1c.innerText = pr.fn+' '+pr.ln +
      ((pr.year!="") ? "; "+pr.year : "") +
      ((pr.teh!="") ? "; "+pr.teh : "") +
      ((pr.format!="") ? "; "+pr.format : "") +
      ((pr.vlas!="")&&(!pr.vlink) ? "; "+pr.vlas : "")+
      ((pr.vlink) ? "; " : "");
    t1.appendChild(t1c);

    if (pr.vlink){
      let t1l = document.createElement ('a');
      t1l.setAttribute ('target',"_blank");
      t1l.setAttribute ('href',pr.vlink);
      t1l.innerText = pr.vlas;
      t1.appendChild(t1l);
    }

    let t1g = document.createElement ('div');
    t1g.setAttribute ('class','spotlight');
    t1g.setAttribute ('data-animation','fade');
    t1g.setAttribute ('data-src',pr.img);
    t1g.setAttribute ('data-description',pr.name+
      ((pr.year!="") ? ", "+pr.year : "")+
      ((pr.teh!="") ? ", "+pr.teh : "") +
      ((pr.format!="") ? ", "+pr.format : "")+
      ((pr.vlas!="") ? ", "+pr.vlas : "")
    );

      let t1i = document.createElement ('img');
      t1i.setAttribute ('src',pr.img);
      t1i.setAttribute ('style',"max-width: 100%; margin-top: 2px; cursor: pointer");
      t1g.appendChild(t1i);

      if (pr.sel==='*'){
        t1a=[];
        let t1temp = document.createElement ('div');
        t1temp.setAttribute ('hidden','true');
        for (let i=0; i<sel.length; i++) {
          let tpr = poi_gjson.features[sel[i]].properties;
          if (pr.img != tpr.img) {
            t1a[i] = document.createElement ('div');
            t1a[i].setAttribute ('class','spotlight');
            t1a[i].setAttribute ('data-animation','fade');
            t1a[i].setAttribute ('data-src',tpr.img);
            t1a[i].setAttribute ('data-description',tpr.name+
              ((tpr.year!="") ? ", "+tpr.year : "")+
              ((tpr.teh!="") ? ", "+tpr.teh : "") +
              ((tpr.format!="") ? ", "+tpr.format : "")+
              ((tpr.vlas!="") ? ", "+tpr.vlas : "")
            );
            t1temp.appendChild (t1a[i])
          }
        t1g.appendChild(t1temp);
        };
      }
      t1.appendChild(t1g);

    //t1.appendChild (t1temp);

    if (pr.phcredit) {
      let t1pc = document.createElement('small');
      t1pc.setAttribute ('style',"display: block; margin-top: -5px; text-align: right")
      t1pc.innerText = 'photo: '+pr.phcredit;
      t1.appendChild(t1pc);
    }

    let t1p1 = [];
    for (let i = 0; i < pr.desc1.length; i++) {
      t1p1[i] = document.createElement('p');
      t1p1[i].innerText = pr.desc1[i];
      t1.appendChild (t1p1[i]);
    };

    let t1p2 = [];
    for (let i = 0; i < pr.desc2.length; i++) {
      t1p2[i] = document.createElement('p');
      t1p2[i].innerText = pr.desc2[i];
      t1.appendChild (t1p2[i]);
    };

    t1tag = document.createElement('em');
    //t1tag.setAttribute ('style',"display: block; margin: 0; margin-bottom: 8px");
    t1tag.innerText = pr.tags;
    t1.appendChild (t1tag);

    let t2 = document.querySelectorAll("div.sidepanel-tab-content")[1];
    t2.textContent="";

    let t2h1 = document.createElement('h1');
    t2h1.setAttribute ('style',"display: block; margin: 0; margin-bottom: 8px");
    t2h1.innerText = pr.fn+' '+pr.ln;
    t2.appendChild(t2h1);

    let t2e = document.createElement('h3');
    t2e.setAttribute ('style',"display: block; margin: 0; margin-bottom: 16px");
    t2e.innerText = pr.era;
    t2.appendChild(t2e);

    let t2p = [];
    for (let i = 0; i < pr.bio.length; i++) {
      t2p[i] = document.createElement('p');
      t2p[i].innerText = pr.bio[i];
      t2.appendChild (t2p[i])
    }
  }

  function featureclick (e){
    lastpr = e.target.feature.properties;
    curfn  = lastpr.fn;
    curln  = lastpr.ln;

    populatepanel (lastpr);
    attrpanel.doOpen (map);
    //console.log(e);
    L.DomEvent.stopPropagation(e);
    //e.originalEvent.preventDefault(); //disableEventPropagation (e.target)
  };
  function highlightFeature(e) {
      info.update(e.target.feature.properties);
  };
  function resetHighlight(e) {
      info.update();
  };
  function onEachFeature (feature, layer) {
    layer.on({
      mouseover  : highlightFeature,
      mouseout   : resetHighlight,
      click      : featureclick,
      touchstart : featureclick
    });
  };

  function style_poi (props,c) {
    let orange = "#ff8000";
    let gray   = "#aaaaaa";
    let red    = "#990000";
    let white  = "#ffffff";
    let black  = "#000000";

    let s = {
      radius: 10,
      weight: 2,
      opacity: 1,
      fillOpacity: 0.8};

    switch (c) {
      case 0  : s.fillColor = orange; s.color = gray; break;
      case 1  : s.fillColor = gray;   s.color = gray; break;
      default : s.fillColor = red;    s.color = red
    };
    return s
  };

  function selectedcount () {
    let num = 0;

     poi_gjson.features.forEach (function (el,i) {
      if (el.properties.sel==="*") {num += 1};
     });

    return num
  }


  var poi_all = L.geoJson(poi_gjson, {
     pointToLayer: function (feature, latlng) {
       return L.circleMarker(latlng, style_poi (feature.properties,0))
     },
     onEachFeature: onEachFeature
  });

  var allbounds = poi_all.getBounds();
  var total     = poi_gjson.features.length;
  var selected  = selectedcount (poi_gjson.features);
  var sel       = [];

  var poi_sel, poi_notsel;
  var selmarkers, selbounds;
  var lastpr;
  var curfn = '';
  var curln = '';

  var allmarkers = L.markerClusterGroup({maxClusterRadius:80, disableClusteringAtZoom:17,
                                      showCoverageOnHover: false});

  allmarkers.addLayer(poi_all);
  map.addLayer(allmarkers);

 // info after poi to use global vars total and selected;
  var info = L.control({position : 'bottomleft'});

  info.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'info');
      this.update();
      return this._div;
  };

  info.update = function (props) {
    this._div.innerHTML =
      '<div><center>'+
      (!props ?
        ((curfn==='') ?
          '<p>Select point to find all author artworks</p>' :
          '<p>Find '+curfn+' '+curln+'</p>') +
        '<small>\/features: '+ total + ((selected==0) ? '' : ', '+curfn+' '+curln+': '+selected) +'\/</small>'
      :
        '<p><b>'+props.name+'</b> <small>\/'+props.id+'\/</small></p>'+
        '<p>' + props.fn+' '+ props.ln +'</p>'
        //'<img src="' + props.img +'" width="100px">'
     )+'</center></div>';
  };
  if (debug) {info.addTo(map)};



  function refreshlayers () {

    function selFilter(feature)    {if (feature.properties.sel === "*") return true};
    function notselFilter(feature) {if (feature.properties.sel !== "*") return true};

    selected = selectedcount();
    map.eachLayer(function (layer) {if (layer!=tiles) {map.removeLayer(layer)}});
    if (selected===0) {map.addLayer(allmarkers)}
    else {

      poi_sel = L.geoJson(poi_gjson, {
        pointToLayer: function (feature, latlng)
          {return L.circleMarker(latlng, style_poi (feature.properties,2))},
        filter : selFilter,
        onEachFeature: onEachFeature
      });
      selbounds = poi_sel.getBounds();

      poi_notsel = L.geoJson(poi_gjson, {
        pointToLayer: function (feature, latlng)
          {return L.circleMarker(latlng, style_poi (feature.properties,1))},
        filter : notselFilter,
        onEachFeature: onEachFeature
      });

      selmarkers = L.markerClusterGroup({maxClusterRadius:80, disableClusteringAtZoom:17,
                                         showCoverageOnHover: false});
      if (true) {//(selected > total/2) {
        map.addLayer(poi_notsel);
        selmarkers.addLayer (poi_sel);
        map.addLayer(selmarkers)
      } else {
        selmarkers.addLayer (poi_notsel);
        map.addLayer (selmarkers);
        map.addLayer (poi_sel)
      }
    };
    info.update()
  };



  function randomselection () {
    sel=[];
    poi_gjson.features.forEach (function (el,i) {
      el.properties.sel = ((Math.random() < 0.3) ? "*" :"");
      if (el.properties.sel === "*") {sel.push(i)}
    });
    selected = selectedcount()
  };

  function clearselection () {
    sel=[];
    poi_gjson.features.forEach (function (el,i) {el.properties.sel = ""});
    selected = 0;
    sel = [];
  };

  function setselection (f) {
    sel=[];
    poi_gjson.features.forEach (function (el,i) {
      el.properties.sel = (f(el.properties) ? "*" : "");
      if (el.properties.sel === "*") {sel.push(i)}
    });
    selected = sel.length
  };

  function findbyfnln (fn,ln) {
    function f (prop) {return (prop.fn === fn) && (prop.ln === ln)}
    if (!fn || !ln) {clearselection(); refreshlayers(); map.fitBounds (allbounds)}
    else            {setselection(f);  refreshlayers(); map.fitBounds (selbounds)}
  };

  map.fitBounds(allbounds)

</script>
</body>
</html>
