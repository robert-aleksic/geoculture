<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>GeoCulture</title>

  <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="css/base.css"/>

    <link rel="stylesheet" href="css/leaflet.css"/>
    <script src="js/leaflet.js"></script>

    <link rel="stylesheet" href="css/markercluster.css"/>
    <link rel="stylesheet" href="css/markercluster.default.css"/>
    <script src="js/markercluster.js"></script>

    <!--<link rel="stylesheet" href="css/coord-projection.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.min.js"></script>
    <script src="js/coord-projection.js"></script>-->

    <link rel="stylesheet" href="css/easy-button.css" />
    <script src="js/easy-button.js"></script>

    <link rel="stylesheet" href="css/fullscreen.css" />
    <script src="js/fullscreen.js"></script>

    <link rel="stylesheet" href="css/locate.min.css" />
    <script src="js/locate.min.js"></script>


    <link rel="stylesheet" href="css/sidepanel.css" />
    <script src="js/sidepanel.js"></script>

    <script src="data/poi.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    .leaflet-container {
      height: 100%;
      width: 100%;
      max-width: 100%;
      max-height: 100%;
    }
  </style>


</head>
<body>

<div id="map" style="width: 100%; height: 100%;">

  <div id="attributes" class="sidepanel" aria-label="side panel" aria-hidden="false">
    <div class="sidepanel-inner-wrapper">
      <nav class="sidepanel-tabs-wrapper" aria-label="sidepanel tab navigation">
        <ul class="sidepanel-tabs">
          <li class="sidepanel-tab">
            <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-1">
              Artwork
            </a>
          </li>
          <li class="sidepanel-tab">
            <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-2">
              About
            </a>
          </li>
          <li class="sidepanel-tab">
            <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-3">
              Author
            </a>
          </li>
          <!-- [...] -->
        </ul>
      </nav>
      <div class="sidepanel-content-wrapper">
        <div class="sidepanel-content">
          <div class="sidepanel-tab-content" data-tab-content="tab-1">
            <p>Image, name, etc</p>
          </div>
          <div class="sidepanel-tab-content" data-tab-content="tab-2">
            <p>Artwork long description</p>
          </div>
          <div class="sidepanel-tab-content" data-tab-content="tab-3">
            <p>About Author</p>
          </div>
          <!-- [...] -->
        </div>
      </div>
    </div>
    <div class="sidepanel-toggle-container">
      <button class="sidepanel-toggle-button" type="button" aria-label="toggle side panel"></button>
    </div>
  </div>

</div>

<script>
  const map = L.map('map', {zoomControl: false, zoomSnap: 0.5});

  const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);

  // utility
  function openpanel(){
    let pandom = L.DomUtil.get('attributes');
    let IS_OPENED = true;
    let opened = L.DomUtil.hasClass(pandom,'opened');
    let closed = L.DomUtil.hasClass(pandom,'closed');

    if (!opened) {L.DomUtil.addClass(pandom,'opened')};
    if (closed)  {L.DomUtil.removeClass(pandom,'closed')}
  };

  function closepanel(){
    let pandom = L.DomUtil.get('attributes');
    let IS_OPENED = false;
    let opened = L.DomUtil.hasClass(pandom,'opened');
    let closed = L.DomUtil.hasClass(pandom,'closed');

    if (opened)  {L.DomUtil.removeClass(pandom,'opened')};
    if (!closed) {L.DomUtil.addClass(pandom,'closed')}
  };


  function featureclick (e){
    // populate side panel
    let t1 = document.querySelectorAll("div.sidepanel-tab-content")[0];
    let pr = e.target.feature.properties;

    t1.textContent="";
    let t1p = document.createElement('p');
    t1p.innerText = pr['glavni narativ uz djelo )pojavljije se kao prvi pasus)'];
    t1.appendChild(t1p);

    let t3 = document.querySelectorAll("div.sidepanel-tab-content")[2];

    t3.textContent="";
    let t3h1 = document.createElement('h1');
    t3h1.innerText = pr.fn+' '+pr.ln;
    t3.appendChild(t3h1);

    let t3p = document.createElement('p');
    t3p.innerText = pr.bio;
    t3.appendChild(t3p);

    openpanel()

  };

  //map.on('mouseover', function(e) {closepanel()});

  // points & clusters
  var style_poi = {
    radius: 6,
    fillColor: "#ff7800",
    color: "#000",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.8
  };

  function highlightFeature(e) {
      info.update(e.target.feature.properties);
  };

  function resetHighlight(e) {
      info.update();
  };

  function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: featureclick
    });
  };
  poi = L.geoJson(gjson_poi, {
     pointToLayer: function (feature, latlng) {
       return L.circleMarker(latlng, style_poi)
     },
     onEachFeature: onEachFeature
  });

  var markers = L.markerClusterGroup({maxClusterRadius:80, disableClusteringAtZoom:16,
                                      showCoverageOnHover: false});
  markers.addLayer(poi);
  map.addLayer(markers);

  map.fitBounds(poi.getBounds());

  // add coordinates control
  // coordP = L.control.coordProjection().addTo(map);

  // add scale control
  var scaleControl = new L.Control.Scale({
            maxwidth: 200,
            position: 'bottomleft',
            metric: true,
            imperial: false,
            updateWhenIdle: true
        });
  scaleControl.addTo(map);

  // add zoom bar
  var zoomBar = L.easyBar([
    L.easyButton('<b>+</b>', function(control, map){map.setZoom(map.getZoom()+1);}),
    L.easyButton('<img src="css/house.svg" width="80%" height="80% style="line-height: 40px">',
      function(control, map){map.fitBounds(poi.getBounds());}),
    L.easyButton('<b>-</b>', function(control, map){map.setZoom(map.getZoom()-1);})
  ]);
  zoomBar.addTo(map);

  // add locate
  L.control.locate().addTo(map);

  // add fullscreen
  map.addControl(
    new L.Control.FullScreen({
      position: 'topleft',
      title: 'Fullscreen',
      titleCancel: 'Exit Fullscreen'
    })
  );

  // side panel
  var attrpanel = L.control.sidepanel('attributes', {
    panelPosition: 'right',
    hasTabs: true,
    tabsPosition: 'top',
    pushControls: true,
    darkMode: true,
    startTab: 'tab-1'
  }).addTo(map);


  // info
  var info = L.control();

  info.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
      this.update();
      return this._div;
  };

  // method that we will use to update the control based on feature properties passed
  info.update = function (props) {
      this._div.innerHTML = (!props ?
          'Hover over a point' :
          '<div><center><p><b>'+props.name+'</b></p></center> <img src="' + props.img +'" width="400px"></div>'
      );
  };

  info.addTo(map);

  //map.on('click', function(e) {closepanel()});

</script>
</body>
</html>
